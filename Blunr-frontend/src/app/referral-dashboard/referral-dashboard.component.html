<app-home-page-area>
  <app-home-sidebar></app-home-sidebar>
  <div class="home-container flex-row">
    <div class="referral-dashboard">
      <!-- Loading State -->
      @if (isLoading) {
        <div class="loading-container text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading referral dashboard...</p>
        </div>
      }

      <!-- Main Dashboard Content -->
      @if (!isLoading && referralStats) {
        <!-- Header Stats Cards -->
        <div class="stats-grid mb-4">
          <div class="stat-card primary">
            <div class="stat-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(referralStats.stats.totalCommissionEarned) }}</h3>
              <p>Total Earnings</p>
            </div>
          </div>

          <div class="stat-card success">
            <div class="stat-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h3>{{ referralStats.stats.totalReferrals }}</h3>
              <p>Total Referrals</p>
            </div>
          </div>

          <div class="stat-card info">
            <div class="stat-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(referralStats.commissionSummary.pendingCommissions) }}</h3>
              <p>Pending Earnings</p>
            </div>
          </div>

          <div class="stat-card warning">
            <div class="stat-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-content">
              <h3>{{ formatCurrency(referralStats.commissionSummary.paidCommissions) }}</h3>
              <p>Paid Commissions</p>
            </div>
          </div>
        </div>

        <!-- Referral Link Section -->
        <div class="referral-link-section mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-link me-2"></i>Your Referral Link</h5>
            </div>
            <div class="card-body">
              <div class="referral-link-container">
                <div class="referral-code mb-3">
                  <label class="form-label">Referral Code:</label>
                  <div class="code-section">
                    <div class="code-display">
                      <span class="code">{{ referralStats.referralCode }}</span>
                    </div>
                    <button
                      class="btn btn-sm btn-outline-secondary mt-2"
                      (click)="showGenerateCodeModal()"
                      title="Generate New Code"
                    >
                      <i class="fas fa-sync-alt me-1"></i>Generate
                    </button>
                  </div>
                </div>

                <div class="referral-url">
                  <label class="form-label">Share this link:</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      [value]="referralStats.referralLink"
                      readonly
                    />
                    <button
                      class="btn btn-primary"
                      type="button"
                      (click)="copyReferralLink()"
                      title="Copy Referral Link"
                      style="width: 60px; flex-shrink: 0"
                    >
                      <i class="fas fa-copy me-1"></i>Copy
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tier Breakdown -->
        <div class="tier-breakdown mb-4">
          <div class="row">
            <div class="col-md-6">
              <div class="tier-card tier1">
                <div class="tier-header">
                  <h6><i class="fas fa-star"></i> Tier 1 (Direct Referrals)</h6>
                </div>
                <div class="tier-stats">
                  <div class="tier-stat">
                    <span class="label">Referrals:</span>
                    <span class="value">{{ referralStats.directReferrals.length }}</span>
                  </div>
                  <div class="tier-stat">
                    <span class="label">Earnings:</span>
                    <span class="value">{{
                      formatCurrency(referralStats.stats.tier1CommissionEarned)
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="tier-card tier2">
                <div class="tier-header">
                  <h6><i class="fas fa-star"></i> Tier 2 (Indirect Referrals)</h6>
                </div>
                <div class="tier-stats">
                  <div class="tier-stat">
                    <span class="label">Referrals:</span>
                    <span class="value">0</span>
                  </div>
                  <div class="tier-stat">
                    <span class="label">Earnings:</span>
                    <span class="value">{{
                      formatCurrency(referralStats.stats.tier2CommissionEarned)
                    }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="dashboard-tabs">
          <ul class="nav nav-pills justify-content-center mb-4">
            <li class="nav-item">
              <button
                class="nav-link"
                [class.active]="isActiveTab('overview')"
                (click)="setActiveTab('overview')"
              >
                <i class="fas fa-chart-pie me-2"></i>Overview
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                [class.active]="isActiveTab('referred-users')"
                (click)="setActiveTab('referred-users')"
              >
                <i class="fas fa-users me-2"></i>Referred Users
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                [class.active]="isActiveTab('commissions')"
                (click)="setActiveTab('commissions')"
              >
                <i class="fas fa-money-bill me-2"></i>Commissions
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                [class.active]="isActiveTab('leaderboard')"
                (click)="setActiveTab('leaderboard')"
              >
                <i class="fas fa-trophy me-2"></i>Leaderboard
              </button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Overview Tab -->
            @if (isActiveTab('overview')) {
              <div class="overview-content">
                <div class="row">
                  <!-- Withdrawal Section -->
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">
                          <i class="fas fa-credit-card me-2"></i>Withdraw Earnings
                        </h6>
                      </div>
                      <div class="card-body">
                        <div class="available-balance mb-3">
                          <small class="text-muted">Available Balance:</small>
                          <h5 class="text-success">
                            {{ formatCurrency(referralStats.commissionSummary.paidCommissions) }}
                          </h5>
                        </div>

                        <div class="withdrawal-form">
                          <div class="mb-3">
                            <label class="form-label">Withdrawal Amount</label>
                            <div class="input-group">
                              <span class="input-group-text">$</span>
                              <input
                                type="number"
                                class="form-control"
                                [(ngModel)]="withdrawAmount"
                                [max]="referralStats.commissionSummary.paidCommissions"
                                min="1"
                                step="0.01"
                                placeholder="Enter amount"
                              />
                            </div>
                          </div>
                          <button
                            class="btn btn-success w-100"
                            [disabled]="
                              isWithdrawing ||
                              !withdrawAmount ||
                              withdrawAmount > referralStats.commissionSummary.paidCommissions
                            "
                            (click)="withdrawEarnings()"
                          >
                            @if (isWithdrawing) {
                              <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="fas fa-download me-2"></i>Request Withdrawal
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Quick Stats -->
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>How It Works</h6>
                      </div>
                      <div class="card-body">
                        <div class="referral-info">
                          <div class="info-item">
                            <div class="info-step">1</div>
                            <div class="info-content">
                              <h6>Share Your Link</h6>
                              <p>Share your unique referral link with friends</p>
                            </div>
                          </div>

                          <div class="info-item">
                            <div class="info-step">2</div>
                            <div class="info-content">
                              <h6>They Sign Up</h6>
                              <p>Your friends join Blunr using your link</p>
                            </div>
                          </div>

                          <div class="info-item">
                            <div class="info-step">3</div>
                            <div class="info-content">
                              <h6>You Earn</h6>
                              <p>Get commissions from their subscriptions & purchases</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            }

            <!-- Referred Users Tab -->
            @if (isActiveTab('referred-users')) {
              <div class="referred-users-content">
                <!-- Filter Controls -->
                <div class="filter-controls mb-3">
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      [class.active]="selectedTier === undefined"
                      (click)="filterByTier(undefined)"
                    >
                      All Tiers
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      [class.active]="selectedTier === 1"
                      (click)="filterByTier(1)"
                    >
                      Tier 1
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      [class.active]="selectedTier === 2"
                      (click)="filterByTier(2)"
                    >
                      Tier 2
                    </button>
                  </div>
                </div>

                <!-- Users List -->
                @if (referredUsers.length > 0) {
                  <div class="users-list">
                    @for (user of referredUsers; track user._id) {
                      <div class="user-item">
                        <div class="user-avatar">
                          <img
                            [src]="user.avatar || '/assets/images/avatar.jpeg'"
                            [alt]="user.username"
                          />
                        </div>
                        <div class="user-info">
                          <h6 class="username">{{ user.username }}</h6>
                          <small class="join-date"
                            >Joined {{ user.joinedAt | date: 'MMM dd, yyyy' }}</small
                          >
                        </div>
                        <div class="user-badges">
                          <span class="badge" [class]="getTierBadgeClass(user.tier)">
                            Tier {{ user.tier }}
                          </span>
                          <span class="badge" [class]="getStatusBadgeClass(user.status)">
                            {{ user.status | titlecase }}
                          </span>
                        </div>
                        <div class="user-earnings">
                          <span class="earnings">{{ formatCurrency(user.totalEarnings) }}</span>
                          <small class="text-muted">Total Earned</small>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- Load More Button -->
                  @if (referredUsers.length < referredUsersTotal) {
                    <div class="text-center mt-3">
                      <button
                        class="btn btn-outline-primary"
                        [disabled]="loadingReferredUsers"
                        (click)="loadMoreReferredUsers()"
                      >
                        @if (loadingReferredUsers) {
                          <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Load More
                      </button>
                    </div>
                  }
                } @else {
                  <app-empty-data [message]="'No referred users found.'"></app-empty-data>
                }
              </div>
            }

            <!-- Commissions Tab -->
            @if (isActiveTab('commissions')) {
              <div class="commissions-content">
                <!-- Filter Controls -->
                <div class="filter-controls mb-3">
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      [class.active]="selectedCommissionStatus === undefined"
                      (click)="filterCommissionsByStatus(undefined)"
                    >
                      All Status
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-warning"
                      [class.active]="selectedCommissionStatus === 'pending'"
                      (click)="filterCommissionsByStatus('pending')"
                    >
                      Pending
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-success"
                      [class.active]="selectedCommissionStatus === 'paid'"
                      (click)="filterCommissionsByStatus('paid')"
                    >
                      Paid
                    </button>
                  </div>
                </div>

                <!-- Commissions List -->
                @if (commissions.length > 0) {
                  <div class="commissions-list">
                    @for (commission of commissions; track commission._id) {
                      <div class="commission-item">
                        <div class="commission-user">
                          <img
                            [src]="commission.fromUser.avatar || '/assets/images/avatar.jpeg'"
                            [alt]="commission.fromUser.username"
                          />
                          <div>
                            <h6>{{ commission.fromUser.username }}</h6>
                            <small>{{ commission.createdAt | date: 'MMM dd, yyyy HH:mm' }}</small>
                          </div>
                        </div>
                        <div class="commission-details">
                          <div class="commission-type">
                            <span class="badge badge-light">{{ commission.type | titlecase }}</span>
                            <span class="badge" [class]="getTierBadgeClass(commission.tier)">
                              Tier {{ commission.tier }}
                            </span>
                          </div>
                        </div>
                        <div class="commission-amount">
                          <span class="amount">{{ formatCurrency(commission.amount) }}</span>
                          <span class="badge" [class]="getStatusBadgeClass(commission.status)">
                            {{ commission.status | titlecase }}
                          </span>
                        </div>
                      </div>
                    }
                  </div>

                  <!-- Load More Button -->
                  @if (commissions.length < commissionsTotal) {
                    <div class="text-center mt-3">
                      <button
                        class="btn btn-outline-primary"
                        [disabled]="loadingCommissions"
                        (click)="loadMoreCommissions()"
                      >
                        @if (loadingCommissions) {
                          <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Load More
                      </button>
                    </div>
                  }
                } @else {
                  <app-empty-data [message]="'No commissions found.'"></app-empty-data>
                }
              </div>
            }

            <!-- Leaderboard Tab -->
            @if (isActiveTab('leaderboard')) {
              <div class="leaderboard-content">
                @if (leaderboard.length > 0) {
                  <div class="leaderboard-list">
                    @for (entry of leaderboard; track entry._id) {
                      <div class="leaderboard-item" [class]="'rank-' + entry.rank">
                        <div class="rank-badge">
                          @if (entry.rank <= 3) {
                            <i class="fas fa-trophy" [class]="'trophy-' + entry.rank"></i>
                          } @else {
                            <span class="rank-number">{{ entry.rank }}</span>
                          }
                        </div>
                        <div class="leader-avatar">
                          <img
                            [src]="entry.avatar || '/assets/images/avatar.jpeg'"
                            [alt]="entry.username"
                          />
                        </div>
                        <div class="leader-info">
                          <h6>{{ entry.username }}</h6>
                          <small>{{ entry.stats.totalReferrals }} referrals</small>
                        </div>
                        <div class="leader-earnings">
                          {{ formatCurrency(entry.stats.totalCommissionEarned) }}
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  @if (loadingLeaderboard) {
                    <div class="text-center">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  } @else {
                    <app-empty-data [message]="'Leaderboard not available.'"></app-empty-data>
                  }
                }
              </div>
            }
          </div>
        </div>
      }

      <!-- No Data State -->
      @if (!isLoading && !referralStats) {
        <app-empty-data [message]="'Unable to load referral dashboard.'"></app-empty-data>
      }
    </div>
  </div>
</app-home-page-area>

<!-- Generate New Referral Code Modal -->
@if (showCodeModal) {
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-sync-alt me-2"></i>Generate New Referral Code
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="hideCodeModal()"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            Enter your desired referral code or leave blank to generate a random one.
          </p>
          <div class="mb-3">
            <label for="newReferralCode" class="form-label">New Referral Code</label>
            <input
              type="text"
              class="form-control"
              id="newReferralCode"
              [(ngModel)]="newReferralCode"
              placeholder="Enter code (6-12 characters)"
              maxlength="12"
              [class.is-invalid]="codeError"
              (input)="onCodeInput()"
            />
            @if (codeError) {
              <div class="invalid-feedback">
                {{ codeError }}
              </div>
            }
            <div class="form-text">
              Code must be between 6 and 12 characters. Leave empty for random generation.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="hideCodeModal()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="isGeneratingCode"
            (click)="generateNewCode()"
          >
            @if (isGeneratingCode) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="fas fa-sync-alt me-1"></i>Generate Code
          </button>
        </div>
      </div>
    </div>
  </div>
}
